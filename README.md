Born2beRoot

Сабжект: https://cdn.intra.42.fr/pdf/pdf/31621/en.subject.pdf

Цель проекта - настроить виртуальную машину VirtualBox под управлением Debian или CentOS и реализовать некоторые базовые вещи, такие как ssh и sudo. Скрипт bash, который вы можете увидеть в репозитории, предназначен для отслеживания состояния систем.

ЧАСТЬ I

Виртуальная машина VirtualBox + создаем структуру под бонусную часть:

Инструкция по VirtualBox:
- На русском : https://hackware.ru/?p=3727
- Оригинал   : https://www.virtualbox.org/manual/ch01.html

Oracle VM VirtualBox-это кроссплатформенное приложение для виртуализации. Что это значит? Во-первых, он устанавливается на ваши существующие компьютеры на базе Intel или AMD, независимо от того, работают ли они под управлением операционных систем Windows, Mac OS X, Linux или Oracle Solaris (операционные системы). Во-вторых, это расширяет возможности вашего существующего компьютера, так что он может одновременно запускать несколько операционных систем внутри нескольких виртуальных машин. Например, вы можете запускать Windows и Linux на своем Mac, запускать Windows Server 2016 на своем сервере Linux, запускать Linux на своем ПК с Windows и так далее, все вместе с существующими приложениями. Вы можете установить и запустить столько виртуальных машин, сколько захотите. Единственными практическими ограничениями являются дисковое пространство и память.

Почему виртуализация полезна?
- Запуск нескольких операционных систем одновременно.
- Более простая установка программного обеспечения.
- Тестирование и аварийное восстановление.
- Консолидация инфраструктуры.

Легче скачать и использовать Debian, чем CentOS (если нет опыта);
Скачать последнюю версию Debian можно тут: https://www.debian.org/distrib/

- Создаем структуру под бонусную часть:
Начало работы :
1. смотрим видео на ютубе https://www.youtube.com/watch?v=13YBlD0SOJo
2. в ВМ создаем общий диск на 30,8Gb (это важно)
3. sda1 на 525Мb, форматим его в ext4, он у нас первичный. Точка монтирования - /boot.
4. sda5 на вecь оставшийся объем. Он у нас первый логический, потому и пятый. (но для LVM- а он физический, логический он для таблицы разделов MBR)
5. Создаём зашифрованный раздел из sda5.
6. Создаём группу томов (LVMGroup), в которую добавляем один лишь зашифрованный раздел sda5.
7. Создаём все необходимые по сабжу логические тома и указываем их размер: root, swap, home, var-log(дефис один) и т.д. логические тома - это наши будущие директории. То, что мы их так назвали, ничего не значит. Сами они не смонтируются.

![image](https://user-images.githubusercontent.com/58044383/142226522-6c2dc1dc-e93a-42e4-b71e-595865602df6.png)

8. Монтируем наши логические тома к файловой структуре дебиана - тут все по наитию. Сначала выбираем тип ФС, которая должна быть у логического тома (для всех, кроме swap, - ext4), потом выбираем точку монтирования (для var-log вручную вписываем var/log).
9. Подтверждаем, что всё ок и запускаем установку дебиана.

10. На шаге с "Software selection" убираем установку графики, оставляем ssh-server и standard system utilities, иначе бан.
GRUB добавляем в главную загрузочную запись.
Затем GRUB устанавливаем на наш единственный диск - sda.

11. Ребутаемся и выбираем первый варик загрузки, вводим Encryption Passphrase. (вводимые символы никак не отображаются на экране, даже ****. пишем и надеемся, что пишем правильно)
12. Вводим логин и пароль пока единственного пользователя. Для меня - einterdi. Пароль 111.
13. Должeн загрузиться терминал.
14. В терминале вводим команду lsblk и проверяем что у нас все сходится

![image](https://user-images.githubusercontent.com/58044383/142226866-eb8f6f47-5244-40ac-a29f-d3cad7cf9323.png)



ЧАСТЬ II

Создаем root и т.д.
Начало работы:
- https://baigal.medium.com/born2beroot-e6e26dfb50ac
- https://www.higithub.com/GuillaumeOz/repo/Born2beroot

Общие термины:

- Aptitude - это менеджер пакетов высокого уровня, который может использовать менеджеры пакетов низкого уровня, такие как apt-get;
- AppArmor - защитный модуль Linus Kernel, который позволяет системному администратору ограничивать возможности программ с помощью профилей программ;
- SSH (Secure Shell или Secure Socket Shell) - это сетевой протокол, который дает пользователям, особенно системным администраторам, безопасный способ доступа к компьютеру по     незащищенной сети;
- Sudo - это альтернатива su для выполнения команд с правами суперпользователя (root).
- Cron — это хронологический демон-планировщик задач, работающий в операционных системах типа Unix, включая дистрибутивы Linux.

1. Запускаем ВМ и установиваем sudo.
Для этого переходим в режим суперпользователя "su -". далее:
  - apt update
  - apt upgrade
  - apt install sudo


 AppArmor
https://help.ubuntu.ru/wiki/руководство_по_ubuntu_server/безопасность/apparmor AppArmor - это реализация Модуля безопасности линукс по управлению доступом на основе имен. AppArmor ограничивает отдельные программы набором перечисленных файлов и возможностями в соответствии с правилами Posix 1003.1e

Проверить статус AppArmor sudo apparmor_status или /usr/sbin/aa-status

2.	НАСТРОЙКА SSH

- // правим конфиг ssh
- $nano /etc/ssh/sshd_config
- // Меняем строки
- #Port 22 => Port 4242
- // чтобы запретить авторизацию от имени суперпользователя
- #PermitRootLogin prohibit-password => PermitRootLogin no
- // Проверяем что ssh включен
- sudo service ssh status
- systemctl status ssh

5. 	ROOT-ПРАВА ПОЛЬЗОВАТЕЛЮ

- // добавляем пользователя
- $usermod -aG sudo <your_username>
- // проверяем что пользователь добавлен в группу
- groups <your_username>
- getent group sudo
- // бэкапим конфиг sudo
- $cp /etc/sudoers /etc/sudoers.backup
- // правим конфиг sudo
- $nano /etc/sudoers
- // добавляем строку с именем пользователя
- <user>    ALL=(ALL:ALL) ALL
- // перезагружаемся
- $reboot

6.	ДОСТУП ЧЕРЕЗ ТЕРМИНАЛ

- Проброс портов в virtualbox
- $ssh <user>@localhost -p 4242
если не получается возможно проблема из-за множества виртуальных машин на которых мы разворачивали систему
тогда на маке в файле /Users/einterdi/.ssh/known_hosts коментим последине записи наычинающиеся на localhost или 127.0.0.1


7.	ФАЙЕРВОЛ

- // устанавливаем ufw
- $apt install ufw
- // убеждаемся, что он не работает
- $ufw status
- // запускаем файервол
- $ufw enable
- // убеждаемся, что он работает
- $sudo ufw status
- sudo ufw status numbered
- // разрешаем наш порт ssh
- $ufw allow 4242
- // удаляем порт 22
- sudo ufw delete (номер строки ненужного порта)

8.	НАСТРОЙКА ВХОДА ПОД SUDO

- // логинимся под рутом
- $su -
- // проверяем группы пользователей
- $groups root
- $groups <user>
- // проверяем и/или меняем имя машины
- $nano /etc/hostname
- // проверяем имя хоста
- $nano /etc/hosts
- // ещё раз правим конфиг судо
- $nano /etc/sudoers
- // меняем фразу при неудачном вводе
- Defaults  badpass_message="Password is wrong, please try again!Do you understand?"
- // Устанавливаем количество попыток ввода
- Defaults        passwd_tries=3
- // прописываем путь где будет фиксироваться все команды с sudo
- Defaults        logfile="/var/log/sudo/sudo.log"
- Defaults        log_input, log_output
- Defaults        requiret
- // создаем папку sudo и в ней файл sudo.log

9. ПОЛЬЗОВАТЕЛИ
- // Посмотреть всех пользователей
- sudo cut -d: -f1 /etc/passwd
-  lastlog
- // Создать пользователя
- sudo adduser <user> //
- sudo useradd <user> // создает пользователя без папки в директории /home
- // Посмотреть в каких группах пользователь
- id -Gn <user>
- grops <user>
- // Удалить пользователя
- sudo deluser <user>
- sudo userdel <user>
- // удалить пользователя из группы
- sudo gpasswd -d <user> <group>

10. Группы
- // Создать группу
- groupadd <you_group>
- // Посмотреть группы
- getent group
- // добаваить пользователя в группу
- usermod -aG <you_group> <you_user>
- // удалить пользователя из группы
- gpasswd -d <you_user> <you_group>

ЧАСТЬ III 
СКРИПТ

СОЗДАНИЕ СКРИПТА

- // для утилиты netstat
- $apt install net-tools
- $su -
- $cd /usr/local/bin/
- $touch monitoring.sh
- $chmod +x ./monitoring.sh
- $nano monitoring.sh
- // скрипт c командами файле monitoring.sh


НАСТРОЙКА CRON
- // добавляем скрипт в расписание (кадые 10 мин)
- $crontab -e
- */10 * * * *  /usr/local/bin/monitoring.sh
- // если чере 30 сек то
- #* * * * * /usr/local/bin/monitoring.sh
- #* * * * * ( sleep 30 ; /usr/local/bin/monitoring.sh )
