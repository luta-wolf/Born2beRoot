# Born2beRoot

Сабжект: https://cdn.intra.42.fr/pdf/pdf/31621/en.subject.pdf

Цель проекта - настроить виртуальную машину VirtualBox под управлением Debian или CentOS и реализовать некоторые базовые вещи, такие как ssh и sudo. Скрипт bash, который вы можете увидеть в репозитории, предназначен для отслеживания состояния систем.

## ЧАСТЬ I
#### Виртуальная машина VirtualBox + создаем структуру под бонусную часть:

Инструкция по VirtualBox:
- На русском : https://hackware.ru/?p=3727
- Оригинал   : https://www.virtualbox.org/manual/ch01.html

Oracle VM VirtualBox-это кроссплатформенное приложение для виртуализации. Что это значит? Во-первых, он устанавливается на ваши существующие компьютеры на базе Intel или AMD, независимо от того, работают ли они под управлением операционных систем Windows, Mac OS X, Linux или Oracle Solaris (операционные системы). Во-вторых, это расширяет возможности вашего существующего компьютера, так что он может одновременно запускать несколько операционных систем внутри нескольких виртуальных машин. Например, вы можете запускать Windows и Linux на своем Mac, запускать Windows Server 2016 на своем сервере Linux, запускать Linux на своем ПК с Windows и так далее, все вместе с существующими приложениями. Вы можете установить и запустить столько виртуальных машин, сколько захотите. Единственными практическими ограничениями являются дисковое пространство и память.

Почему виртуализация полезна?
- Запуск нескольких операционных систем одновременно.
- Более простая установка программного обеспечения.
- Тестирование и аварийное восстановление.
- Консолидация инфраструктуры.

Легче скачать и использовать Debian, чем CentOS (если нет опыта);
Скачать последнюю версию Debian можно тут: https://www.debian.org/distrib/

- Создаем структуру под бонусную часть:
Начало работы :
1. смотрим видео на ютубе https://www.youtube.com/watch?v=13YBlD0SOJo
2. в ВМ создаем общий диск на 30,8Gb (это важно)
3. sda1 на 525Мb, форматим его в ext4, он у нас первичный. Точка монтирования - /boot.
4. sda5 на вecь оставшийся объем. Он у нас первый логический, потому и пятый. (но для LVM- а он физический, логический он для таблицы разделов MBR)
5. Создаём зашифрованный раздел из sda5.
6. Создаём группу томов (LVMGroup), в которую добавляем один лишь зашифрованный раздел sda5.
7. Создаём все необходимые по сабжу логические тома и указываем их размер: root, swap, home, var-log(дефис один) и т.д. логические тома - это наши будущие директории. То, что мы их так назвали, ничего не значит. Сами они не смонтируются.

![image](https://user-images.githubusercontent.com/58044383/142226522-6c2dc1dc-e93a-42e4-b71e-595865602df6.png)

8. Монтируем наши логические тома к файловой структуре дебиана - тут все по наитию. Сначала выбираем тип ФС, которая должна быть у логического тома (для всех, кроме swap, - ext4), потом выбираем точку монтирования (для var-log вручную вписываем var/log).
9. Подтверждаем, что всё ок и запускаем установку дебиана.

10. На шаге с "Software selection" убираем установку графики, оставляем ssh-server и standard system utilities, иначе бан.
GRUB добавляем в главную загрузочную запись.
Затем GRUB устанавливаем на наш единственный диск - sda.

11. Ребутаемся и выбираем первый варик загрузки, вводим Encryption Passphrase. (вводимые символы никак не отображаются на экране, даже ****. пишем и надеемся, что пишем правильно)
12. Вводим логин и пароль пока единственного пользователя. Для меня - einterdi. Пароль 111.
13. Должeн загрузиться терминал.
14. В терминале вводим команду lsblk и проверяем что у нас все сходится

![image](https://user-images.githubusercontent.com/58044383/142226866-eb8f6f47-5244-40ac-a29f-d3cad7cf9323.png)



## ЧАСТЬ II
#### Создаем root и т.д.

Начало работы:
- https://baigal.medium.com/born2beroot-e6e26dfb50ac
- https://www.higithub.com/GuillaumeOz/repo/Born2beroot

Общие термины:

	Aptitude - это менеджер пакетов высокого уровня, который может использовать менеджеры пакетов низкого уровня, такие как apt-get;
	AppArmor - защитный модуль Linus Kernel, который позволяет системному администратору ограничивать возможности программ с помощью профилей программ;
	SSH (Secure Shell или Secure Socket Shell) - это сетевой протокол, который дает пользователям, особенно системным администраторам, безопасный способ доступа к компьютеру по     незащищенной сети;
	Sudo - это альтернатива su для выполнения команд с правами суперпользователя (root).
	Cron — это хронологический демон-планировщик задач, работающий в операционных системах типа Unix, включая дистрибутивы Linux.

#### 1. SUDO.
	Для этого переходим в режим суперпользователя "su -". далее:
	apt update
	apt upgrade
	apt install sudo


 AppArmor
https://help.ubuntu.ru/wiki/руководство_по_ubuntu_server/безопасность/apparmor AppArmor - это реализация Модуля безопасности линукс по управлению доступом на основе имен. AppArmor ограничивает отдельные программы набором перечисленных файлов и возможностями в соответствии с правилами Posix 1003.1e

Проверить статус AppArmor sudo apparmor_status или /usr/sbin/aa-status

#### 2.	НАСТРОЙКА SSH

	// правим конфиг ssh
	$nano /etc/ssh/sshd_config
	// Меняем строки
	#Port 22 => Port 4242
	// чтобы запретить авторизацию от имени суперпользователя
	#PermitRootLogin prohibit-password => PermitRootLogin no
	// Проверяем что ssh включен
	sudo service ssh status
	systemctl status ssh

#### 3. 	ROOT-ПРАВА ПОЛЬЗОВАТЕЛЮ

	// добавляем пользователя
	$usermod -aG sudo <your_username>
	// проверяем что пользователь добавлен в группу
	groups <your_username>
	getent group sudo
	// бэкапим конфиг sudo
	$cp /etc/sudoers /etc/sudoers.backup
	// правим конфиг sudo
	$nano /etc/sudoers
	// или
	$ sudo visudo
	добавляем строку с именем пользователя
	<user>    ALL=(ALL:ALL) ALL
	// перезагружаемся
	$reboot

#### 4.	ДОСТУП ЧЕРЕЗ ТЕРМИНАЛ
	Проброс портов в virtualbox
	$ssh <user>@localhost -p 4242
	если не получается возможно проблема из-за множества виртуальных машин на которых мы разворачивали систему
	тогда на маке в файле /Users/einterdi/.ssh/known_hosts коментим последине записи наычинающиеся на localhost или 127.0.0.1


#### 5.	ФАЙЕРВОЛ
	// устанавливаем ufw
	$apt install ufw
	// убеждаемся, что он не работает
	$ufw status
	// запускаем файервол
	$ufw enable
	// убеждаемся, что он работает
	$sudo ufw status
	sudo ufw status numbered
	// разрешаем наш порт ssh
	$ufw allow 4242
	// удаляем порт 22
	sudo ufw delete (номер строки ненужного порта)

#### 6.	НАСТРОЙКА ВХОДА ПОД SUDO
	// логинимся под рутом
	$su -
	// проверяем группы пользователей
	$groups root
	$groups <user>
	// проверяем и/или меняем имя машины
	$nano /etc/hostname
	// проверяем имя хоста
	$nano /etc/hosts
	// ещё раз правим конфиг судо
	$nano /etc/sudoers
	// меняем фразу при неудачном вводе
	Defaults  badpass_message="Password is wrong, please try again!Do you understand?"
	// Устанавливаем количество попыток ввода
	Defaults        passwd_tries=3
	// прописываем путь где будет фиксироваться все команды с sudo
	Defaults        logfile="/var/log/sudo/sudo.log"
	Defaults        log_input, log_output
	Defaults        requiret
	// создаем папку sudo и в ней файл sudo.log

#### 7. ПОЛЬЗОВАТЕЛИ
	// Посмотреть всех пользователей
	sudo cut -d: -f1 /etc/passwd
	lastlog
	// Создать пользователя
	sudo adduser <user> //
	sudo useradd <user> // создает пользователя без папки в директории /home
	// Посмотреть в каких группах пользователь
	id -Gn <user>
	grops <user>
	// Удалить пользователя
	sudo deluser <user>
	sudo userdel <user>
	// удалить пользователя из группы
	sudo gpasswd -d <user> <group>

#### 8. ГРУППЫ
	// Создать группу
	groupadd <you_group>
	// Посмотреть группы
	getent group
	// добаваить пользователя в группу
	usermod -aG <you_group> <you_user>
	// удалить пользователя из группы
	gpasswd -d <you_user> <you_group>
	
#### 9.	ПОЛИТИКА ПАРОЛЕЙ
	// устанавливаем утилиту политики
	$apt-get install libpam-pwquality
	// правим файл политики паролей
	%nano /etc/login.defs
	// меняем значения строк как здесь:
	PASS_MAX_DAYS 30
	PASS_MIN_DAYS 2
	PASS_WARN_AGE 7
	// на всякий пожарный бэкапим конфиг
	$cp /etc/pam.d/common-password /etc/pam.d/common-password.backup
	// правим конфиг
	$nano /etc/pam.d/common-password
	// дописываем в эту строку следующим образом:
	password        requisite	pam_pwquality.so retry=3 maxrepeat=3 minlen=10 dcredit=-1 ucredit=-1 lcredit=-1 usercheck=1 difok=7
	password        requisite	pam_pwquality.so retry=3 maxrepeat=3 minlen=10 dcredit=-1 ucredit=-1 lcredit=-1 enforce_for_root
	// меняем пароли пользователей в соответствии с политикой
	$passwd user
	$passwd root	
	
#### 9.	СМЕНА ИМЕНИ ХОСТА
	// в этих файлах меняем 
	$nano /etc/hosts
	$nano /etc/hostname

## ЧАСТЬ III 
#### СКРИПТ

#### 1. СОЗДАНИЕ СКРИПТА
	// для утилиты netstat
	$apt install net-tools
	$su -
	$cd /usr/local/bin/
	$touch monitoring.sh
	$chmod +x ./monitoring.sh
	$nano monitoring.sh
	// скрипт c командами файле monitoring.sh

#### 2. СКРИПТ
	#!/bin/bash
	wall $'#Architecture:' `uname -a` \
	$'\n#CPU physical : '`nproc` \
	$'\n#vCPU :' `cat /proc/cpuinfo | grep processor | wc -l` \
	$'\n#Memory Usage:' `free -m | grep Mem | awk '{printf "%d/%d (%.1f%%)", $3, $2, $3*100/$2}'` \
	$'\n#Disk Usage: '`df -h | grep root | awk '{print $3"/"$2" ("$5")"}'` \
	$'\n#CPU load: '`cat /proc/loadavg | awk '{printf "%.1f%%", $1}'` \
	$'\n#Last boot:' `who -b | awk '{print $3" "$4}'` \
	$'\n#LVM use:' `lsblk |grep lvm | awk '{if ($1) {print "yes";exit;} else {print "no"} }'` \
	$'\n#Connection TCP:' `netstat -an | grep ESTABLISHED |  wc -l` "ESTABLISHED" \
	$'\n#User log:' `who | wc -l` \
	$'\nNetwork: IP' `hostname -I`"("`ip a | grep link/ether | awk '{print $2}'`")" \
	$'\n#Sudo :' `cat /var/log/sudo/sudo.log | grep COMMAND | wc -l` "cmd"


#### 3. НАСТРОЙКА CRON
	// добавляем скрипт в расписание (кадые 10 мин)
	$crontab -e
	*/10 * * * *  /usr/local/bin/monitoring.sh
	// если чере 30 сек то
	#* * * * * /usr/local/bin/monitoring.sh
	#* * * * * ( sleep 30 ; /usr/local/bin/monitoring.sh )
  
   ## ЧАСТЬ IV
  #### БOНУСЫ
  	
#### 1.	УСТАНОВКА СЕРВЕРА
	$apt install lighttpd
	// смотрим порты
	$nano /etc/lighttpd/lighttpd.conf
	// разрешаем доступ по порту сервера
	$ufw allow 80
	$ufw allow 8080
	Пробрасываем порты в virtualbox
	Заходим в браузере по ip
	127.0.0.1

#### 1.	УСТАНОВКА БАЗЫ ДАННЫХ
	// входим под рутом
	$su -
	// настраиваем MariaDB:
	$apt install mariadb-server - установка
	$mysql_secure_installation - настройка (везде yes, кроме установки пароля рута и в первом запросе нажать Enter)
	// входим в оболочку MariaDB
	$mariadb
	// создаём базу
	>CREATE DATABASE wordpress;
	// создаём пользователия для дб
	>CREATE USER '<user>'@'localhost' IDENTIFIED BY 'password';
	// предоставляем пользователю полные привелегии для дб
	>GRANT ALL ON wordpress.* TO '<user>'@'localhost';
	>FLUSH PRIVILEGES;
	>exit
	// проверка юзера
	$mariadb -u <user> -p
	// проверка бд
	>SHOW DATABASES;

#### 3.	УСТАНОВКА PHP
	// ставим php
	$apt install php php-cgi php-mysql
	// запускам север в режиме fastcgi
	$lighty-enable-mod fastcgi
	// подключаем к сереверу php
	$lighty-enable-mod fastcgi-php
	// перезагружаем сервис
	$service lighttpd force-reload


#### 4.	УСТАНОВКА WORDPRESS
	// заходим под рут
	$su -
	// скачиваем вордпресс
	$wget https://ru.wordpress.org/latest-ru_RU.tar.gz
	// копируем его в папку сервера
	$cp latest-ru_RU.tar.gz /var/www/html/
	// распаковываем
	$tar -xvzf latest-ru_RU.tar.gz

#### 5.	ПРАВА ПАПКАМ
	// меняем владельца папки с вордпрессом
	$chown -R www-data:www-data /var/www/html/wordpress
	// применяем правильные права для всех папок и файлов
	$find /var/www/html/wordpress -type d -exec chmod 750 {} \;
	$find /var/www/html/wordpress -type f -exec chmod 640 {} \;

#### 6.	УСТАНОВКА WP
	// заходим через браузер:
	http://127.0.0.1/wordpress
	// настраиваем и наслаждаемся)

#### 7.	ДОПОЛНИТЕЛЬНЫЙ СЕРВИС: VSFTPD
	// устанавливаем
	$apt install vsftpd
	// останавливаем
	$service vsftpd stop
	// правим конфиг
	$nano /etc/vsftpd.conf
	// раскомментировать
	write_enable=YES
	chroot_local_user=YES
	// разрешаем порт
	$ufw allow 20
	// пробрасываем порт 20
	// запускаем ftp-сервер:
	$service vsftpd start
	// проверяем что всё получилось:
	$service vsftpd status
  
  ## ЧАСТЬ X
  #### ПОЛЕЗНОЕ
  	service --status-all // - показывает работу всех сервисов
	passwd -S <user>     // - посмотреть политику паролей для данного пользователя
	aa-status		// - статус AppArmor
	htop			// - красивое визуализация работы компьютера
  
  ## ЧАСТЬ V
  #### ЗАЩИТА
  
1) Как работает виртуальная машина.
2) Выбор операционки.
3) Базовые отличия между CentOS и Debian.
4) Смысл (цель) использования виртуальных машин.
5) Отличия apt и aptitude, что такое APPArmor
6) Во время защиты должен вылезать скрипт каждые 10 минут.

7) Убедиться, что нет графического интерфейса при запуске машины
8) При подключении к машине должен быть затребован пароль
9) К машине нужно подключиться под каким-то пользователем, который не root -- check
10) Проверить, что пароли соответствуют политике паролей.
11) Проверить, что UFW запущен
12) Проверить, что SSH запущен
13) Проверить, что это дебиан или центос

14) Проверить, что пользователь с именем stycho есть и входит в группы sudo и stycho42
(у меня не было, поэтому: 
sudo groupadd stycho42
sudo usermod -a -G stycho42 stycho)
15) Проверить корректную настройку политики паролей, выполнив следующие шаги:
а) Создайте нового пользователя с паролем, удовлетворяющем сабджект. Тут надо объяснить, как конфигурируется политика паролей. (Обычно нужно отредактировать один или два файла для этого)
б) Когда новый пользователь создан, создать группу evaluating и добавить в неё пользователя. Проверить, что пользователь присутствует в этой группе.
16) Объяснить преимущества политики паролей.

17) Проверить, что хостнейм - stycho42
18) Изменить хотстнейм на логин_проверяющего_42 и ребутнуться, проверив, что хостнейм сменился. 
либо	sudo hostname <новое_имя_хоста>
		sudo nano /etc/hostname
		sudo nano /etc/hosts
либо без первой строчки и ребутаемся
19) Можно вернуть старый хостнейм
20) Проверить разбивку на разделы и сравнить с сабджектом.
21) Тут ещё надо затереть про LVM: что это и как с ней работать.

22) Проверить, что судо установлена на машине
23) Добавить какого-нибудь пользователя в группу судо
24) Объяснить, как работает судо.
25) Сгонять в папку /ver/log/sudo, проверить что она вообще есть, и что в ней есть файлы, проверить их содержимое. Проверить, что при выполнении какой-либо команды от судо логгируется в журнал.

26) Проверить, что UFW корректно установлена на машине
27) Проверить, что UFW работает
28) Объяснить, что это за зверь и зачем его юзать.
29) Вывести все активные правила в UFW и убедиться, что там есть правило для порта 4242
30) Добавить новое правило для порта 8080 и проверить, что оно добавилось
31) Удалить это правило

32) Проверить, что SSH правильно установлен на машине
33) Проверить, что он норм работает
34) Объяснить, что такое SSH и зачем он нужен.
35) Убедиться, что SSH слушает только 4242 порт.
36) Зайти на сервак через ssh как новый пользователь (которого создали при проверке)
37) Проверить, что нельзя зайти на сервак под рутом.

38) Показать код скрипта и объяснить его
39) Объяснить, что такое cron 
40) Рассказать, как запускать скрипт каждые 10 минут
41) Сделать так, чтоб скрипт запускался каждую минуту
42) Сделать так, чтоб скрипт не запускался каждую минут после перезагрузки сервака.

Бонусная часть

43) Проверить, что разбиение на разделы корректное
44) Проверить работу вордпресса, что он юзает только lighty, MariaDB, Php
45) Проверить, что установлен ещё какой-то сервис и он робит. Объяснить, как он робит и почему он полезный.
